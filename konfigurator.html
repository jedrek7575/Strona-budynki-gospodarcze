<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZABUDO - Konfigurator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: '#3e6ae1'
                    }
                }
            }
        };
    </script>
    <style>
        :root {
            --scrollbar-width: 0px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
        }

        /* --- OPTYMALIZACJA OBRAZÓW --- */
        .visual-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f4f4f5;
        }

        .house-visual {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            object-position: center center;
            opacity: 0;
            transition: opacity 300ms ease-in-out;
            will-change: opacity;
            z-index: 10;
        }
        
        .house-visual.loaded {
            opacity: 1;
        }

        /* --- UI UTILS --- */
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f8fafc;
        }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }

        .right-panel-inner {
            padding-left: 1rem;
            padding-right: calc(1rem + var(--scrollbar-width));
        }

        /* --- ANIMACJE --- */
        @keyframes bonusGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .bonus-banner-animated {
            background: linear-gradient(90deg, #E3C66A 0%, #F4E6B7 50%, #E3C66A 100%);
            background-size: 180% 180%;
            animation: bonusGlow 9s ease-in-out infinite alternate;
        }

        @keyframes chatPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes chatColorMorph {
            0% { background-color: var(--chat-fab-base-color, #18181b); color: var(--chat-fab-ink-color, #ffffff); }
            100% { background-color: #ffffff; color: var(--chat-fab-base-color, #18181b); }
        }

        .chat-fab {
            --chat-fab-base-color: #18181b;
            --chat-fab-ink-color: #ffffff;
            position: relative;
            border: none;
            animation: chatColorMorph 2s cubic-bezier(0.68, -0.2, 0.27, 1.2) infinite alternate,
                       chatPulse 2s cubic-bezier(0.22, 1, 0.36, 1) infinite;
            box-shadow: 0 12px 26px rgba(15, 23, 42, 0.3);
        }

        .chat-fab-disabled {
            filter: blur(1.5px);
            opacity: 0.5;
            pointer-events: none;
            animation: none;
        }

        /* --- NOWOCZESNE PRZYCISKI KOLORÓW --- */
        .color-picker { display: flex; flex-direction: column; align-items: center; gap: 1rem; padding-top: 0.25rem; }
        .color-meta { min-height: 5.25rem; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; gap: 0.25rem; }
        .color-meta-price { font-size: 1.3rem; line-height: 1.2; font-weight: 600; color: #52525b; }
        .color-meta-name { font-size: 2rem; line-height: 1.1; font-weight: 600; letter-spacing: -0.02em; color: #09090b; }
        .color-swatches { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 1rem; }
        
        .color-btn {
            position: relative; 
            width: 3.5rem; 
            height: 3.5rem; 
            border-radius: 50%;
            background: var(--swatch-color, #d4d4d8);
            /* Delikatny border wewnętrzny dla jasnych kolorów */
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06); 
            cursor: pointer; 
            transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hover effect - lekkie powiększenie */
        .color-btn:hover {
            transform: scale(1.05);
        }

        /* Selected state - Pierścień focusa (Apple style) */
        .color-btn[data-selected="true"] {
            transform: scale(1.1);
            /* Biały odstęp + czarny pierścień */
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #18181b; 
        }

        @media (max-width: 640px) {
            .color-meta { min-height: 4.5rem; }
            .color-meta-price { font-size: 1.05rem; }
            .color-meta-name { font-size: 1.55rem; }
            .color-btn { width: 3rem; height: 3rem; }
        }

        @media (min-width: 768px) {
            .right-panel-inner { padding-left: 2rem; padding-right: calc(2rem + var(--scrollbar-width)); }
        }
    </style>
</head>

<body class="bg-white text-zinc-900 antialiased">

    <div id="bonus-banner" class="bonus-banner-animated sticky top-0 z-50 h-11 w-full text-black text-[14px]">
        <div class="h-full flex items-center justify-center text-center px-4">
            Kwalifikuje się do otrzymania Bonusu ZABUDO w wysokości 18 750 zł.
            <button id="open-terms-modal" type="button" class="ml-1 underline cursor-pointer">Zobacz warunki.</button>
        </div>
    </div>

    <header class="sticky top-11 z-40 bg-white/90 backdrop-blur border-b border-zinc-100">
        <div class="max-w-[1680px] mx-auto h-16 px-4 md:px-8 flex items-center justify-between">
            <a href="index.html" class="font-semibold tracking-[0.35em] text-sm md:text-base">ZABUDO</a>
            <div class="text-sm text-zinc-600">Konfigurator domu</div>
        </div>
    </header>

    <main class="max-w-[1680px] mx-auto grid xl:grid-cols-[1.48fr_.52fr] min-h-[calc(100vh-4rem)]">
        
        <section class="xl:sticky xl:top-[6.75rem] xl:h-[calc(100vh-6.75rem)] bg-white w-full">
            <div class="h-full w-full relative flex flex-col p-3 md:px-8 md:pt-3 md:pb-6">
                <div class="visual-container flex-1 relative rounded-2xl overflow-hidden bg-zinc-50 border border-zinc-100 aspect-video xl:aspect-auto">
                    
                    <img id="gallery-image" src="" alt="Wizualizacja domu" class="house-visual" decoding="async" />
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-900/10 to-transparent pointer-events-none z-20"></div>

                    <button id="gallery-prev" class="absolute z-30 left-3 md:left-6 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-11 h-11 rounded-md bg-white/90 border border-zinc-200 hover:bg-white transition shadow-sm" aria-label="Poprzednia wizualizacja">
                        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2">
                            <path d="M15 18l-6-6 6-6" />
                        </svg>
                    </button>
                    <button id="gallery-next" class="absolute z-30 right-3 md:right-6 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-11 h-11 rounded-md bg-white/90 border border-zinc-200 hover:bg-white transition shadow-sm" aria-label="Następna wizualizacja">
                        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2">
                            <path d="M9 18l6-6-6-6" />
                        </svg>
                    </button>

                    <div id="gallery-dots" class="absolute z-30 bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-2"></div>
                </div>
            </div>
        </section>

        <section id="right-panel" class="bg-white relative">
            <div class="right-panel-inner py-6 md:py-8 pb-32 space-y-8">
                
                <div>
                    <h2 id="gallery-title" class="text-2xl md:text-5xl font-semibold tracking-tight mt-1 text-center"></h2>
                    <p id="gallery-subtitle" class="text-zinc-500 mt-6 text-center text-[12px] md:text-[14px] font-medium whitespace-nowrap"></p>
                    
                    <div class="grid md:grid-cols-3 gap-4 mt-6">
                        <div class="text-center p-3 rounded-xl bg-zinc-50 border border-zinc-100 transition-all duration-300">
                            <p id="surface-area-value" class="text-xl md:text-2xl font-semibold text-zinc-900 transition-all">70 m²</p>
                            <p class="text-zinc-500 text-xs mt-1">Powierzchnia użytkowa</p>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-zinc-50 border border-zinc-100">
                            <p class="text-xl md:text-2xl font-semibold text-zinc-900">60 dni</p>
                            <p class="text-zinc-500 text-xs mt-1">Czas budowy</p>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-zinc-50 border border-zinc-100">
                            <p class="text-xl md:text-2xl font-semibold text-zinc-900">50%</p>
                            <p class="text-zinc-500 text-xs mt-1">Mniej energii (OZE)</p>
                        </div>
                    </div>
                </div>

                <section>
                    <h3 class="text-lg font-semibold mb-3 text-center">Model</h3>
                    <div id="model-options" class="grid gap-3"></div>
                </section>

                <section>
                    <h3 class="text-lg font-semibold mb-3 text-center">Kolor elewacji</h3>
                    <div id="color-options" class="mt-1"></div>
                </section>

                <section>
                    <h3 class="text-lg font-semibold mb-3 text-center">Taras (wybierz jedną opcję)</h3>
                    <div id="terrace-options" class="space-y-3"></div>
                </section>

                <section>
                    <h3 class="text-lg font-semibold mb-3 text-center">Garaż (wybierz jedną opcję)</h3>
                    <div id="garage-options" class="space-y-3"></div>
                </section>

                <section class="!mt-6 pt-6 border-t border-zinc-100">
                    <div class="text-center">
                        <p class="text-[13px] leading-5 font-normal text-zinc-500">
                            Z wyłączeniem szac. oszczędności na najmie w ciągu <span id="savings-years-inline" class="font-medium text-zinc-700">5 lat</span> w wysokości <span id="savings-5y-inline" class="font-medium text-zinc-700">29 000 zł</span>
                        </p>
                        <button id="open-savings-modal" class="mt-2 text-[13px] font-medium text-accent hover:text-blue-700 transition underline decoration-2 decoration-accent/30 hover:decoration-accent">
                            Edytuj kalkulację oszczędności
                        </button>
                    </div>
                </section>

                <section id="summary-section" class="rounded-2xl border border-zinc-200 bg-zinc-50/50 p-5 md:p-6">
                    <h3 class="text-lg font-semibold text-center mb-4">Podsumowanie konfiguracji</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center justify-between"><span class="text-zinc-600">Model</span><span id="sum-model" class="font-medium text-zinc-900"></span></div>
                        <div class="flex items-center justify-between"><span class="text-zinc-600">Kolor</span><span id="sum-color" class="font-medium text-zinc-900"></span></div>
                        <div class="flex items-center justify-between"><span class="text-zinc-600">Taras</span><span id="sum-terrace" class="font-medium text-zinc-900"></span></div>
                        <div class="flex items-center justify-between"><span class="text-zinc-600">Garaż</span><span id="sum-garage" class="font-medium text-zinc-900"></span></div>
                        
                        <div class="pt-4 mt-4 border-t border-zinc-200 flex items-center justify-between text-base">
                            <span class="font-semibold text-zinc-900">Cena całkowita</span>
                            <span id="sum-total" class="font-bold text-lg text-zinc-900"></span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-accent bg-accent/5 p-2 rounded-lg border border-accent/10">
                            <span class="font-medium">40% płatne dzisiaj</span>
                            <span id="sum-today" class="font-bold"></span>
                        </div>
                    </div>
                </section>
            </div>

            <div id="payment-bar" class="fixed bottom-0 z-30 w-full transform transition-all duration-300 ease-out translate-y-0 opacity-100">
                <div class="w-full border-t border-zinc-200 bg-white/95 backdrop-blur-md shadow-[0_-4px_20px_rgba(0,0,0,0.05)] px-4 md:px-8 py-3 grid grid-cols-[1fr_auto] items-center gap-4 max-w-[1680px] mx-auto xl:pr-[calc(2rem+0.52fr)]">
                    <div class="min-w-0">
                        <p class="text-xs text-zinc-500 font-medium uppercase tracking-wide">40% płatne dzisiaj</p>
                        <p id="bar-today" class="text-xl md:text-2xl font-bold text-zinc-900 leading-tight mt-0.5 whitespace-nowrap"></p>
                        <p id="bar-effective" class="text-xs text-zinc-500 mt-0.5 hidden"></p>
                    </div>
                    <button class="inline-flex items-center justify-center h-11 md:h-12 px-6 md:px-8 rounded-xl bg-accent text-white text-sm md:text-base font-semibold hover:bg-blue-600 shadow-lg shadow-blue-500/20 transition-all active:scale-95 whitespace-nowrap">
                        Przejdź do płatności
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div id="savings-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="savings-modal-backdrop" class="absolute inset-0 bg-zinc-900/60 backdrop-blur-sm transition-opacity"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-xl transform rounded-2xl bg-white shadow-2xl transition-all p-6">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-xl font-bold text-zinc-900">Edytuj oszczędności</h3>
                    <button id="close-savings-modal" class="text-zinc-400 hover:text-zinc-600 transition p-2 hover:bg-zinc-100 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between py-2 border-b border-zinc-100">
                        <span class="text-zinc-600">Energia (izolacja/OZE)</span>
                        <span class="font-semibold text-zinc-900">~2 450 zł/rok</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-zinc-100">
                        <span class="text-zinc-600">Czynsz</span>
                        <span class="font-semibold text-zinc-900">~12 000 zł/rok</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-zinc-100">
                        <span id="savings-rent-label" class="text-zinc-600">Najem (2 500 zł/mc)</span>
                        <span id="savings-rent-yearly" class="font-semibold text-zinc-900">30 000 zł/rok</span>
                    </div>
                    <div class="flex justify-between py-3">
                        <span class="font-bold text-zinc-800">Razem oszczędności</span>
                        <span id="savings-yearly" class="font-bold text-emerald-600">49 000 zł/rok</span>
                    </div>
                </div>

                <label class="mt-5 flex items-center justify-between gap-4 rounded-xl border border-zinc-200 p-4 cursor-pointer hover:bg-zinc-50 transition">
                    <div>
                        <p class="font-semibold text-zinc-900">Uwzględnij w cenie</p>
                        <p class="text-xs text-zinc-500 mt-1">Odejmij szacowane oszczędności od ceny domu</p>
                    </div>
                    <div class="relative inline-flex items-center cursor-pointer">
                        <input id="savings-toggle" type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-zinc-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                    </div>
                </label>

                <div class="mt-5 rounded-xl bg-zinc-50 border border-zinc-200 p-5">
                    <div class="flex justify-between items-end mb-2">
                        <p class="text-sm text-zinc-500">Cena regularna</p>
                        <p id="modal-base-total" class="text-lg font-semibold text-zinc-900"></p>
                    </div>
                    <div class="flex justify-between items-end mb-4 text-emerald-600">
                        <span class="text-sm font-medium">Minus oszczędności (1 rok)</span>
                        <span id="modal-savings-deduction" class="font-bold">- 49 000 zł</span>
                    </div>
                    <div class="pt-4 border-t border-zinc-200">
                        <p class="text-xs text-zinc-500 uppercase tracking-wide font-semibold">Efektywna cena (po roku)</p>
                        <p id="modal-effective-total" class="text-3xl font-bold text-zinc-900 mt-1"></p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-zinc-200 flex justify-between items-center">
                        <p class="text-sm text-zinc-600">Suma oszczędności po <span id="modal-years-total" class="font-bold">5 latach</span>: <span id="modal-5y-total" class="font-bold text-emerald-600">245 000 zł</span></p>
                        <button id="open-rent-savings-modal" class="text-sm font-semibold text-accent hover:underline">Dostosuj</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="terms-modal" class="fixed inset-0 z-[60] hidden">
        <div id="terms-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl rounded-2xl bg-white shadow-2xl border border-zinc-200 p-6 relative">
                 <button id="close-terms-modal" class="absolute top-4 right-4 p-2 rounded-full hover:bg-zinc-100 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h3 class="text-xl font-bold mb-4">Warunki Bonusu</h3>
                <div class="text-sm text-zinc-600 space-y-3 text-justify leading-relaxed max-h-[70vh] overflow-y-auto pr-2 scrollbar-thin">
                    <p>Bonus Zabudo dotyczy modeli DOM50 i DOM70 z wyłączeniem wersji DOM35, zamówionych do 31 marca 2026 r. (włącznie).</p>
                    <p>Jeśli przelew zadatku nie wpłynie na konto ZABUDO do 31 marca 2026 r., bonus Zabudo nie będzie uwzględniony w rezerwacji.</p>
                    <p>Jeżeli przelew został wysłany wcześniej, ale nie dotarł w terminie z przyczyn leżących po stronie banku, klient zachowuje prawo do skorzystania z oferty pod warunkiem przedstawienia potwierdzenia nadania przelewu w wymaganym terminie.</p>
                    <p>Oferta nie obejmuje samych garaży i tarasów. Zachęta ta jest widoczna na fakturze za dom jako „Bonus Zabudo”.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="rent-savings-modal" class="fixed inset-0 z-[60] hidden">
        <div id="rent-savings-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl p-6">
                <h3 class="text-xl font-bold mb-6">Parametry najmu</h3>
                
                <div class="space-y-5">
                    <label class="block">
                        <span class="text-sm font-medium text-zinc-700">Miesięczny koszt najmu/czynszu</span>
                        <div class="relative mt-1">
                            <input id="rent-monthly-input" type="number" min="0" step="100" class="block w-full rounded-lg border-zinc-300 pr-12 focus:border-accent focus:ring-accent sm:text-sm h-11 px-3 border" placeholder="2500">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-zinc-500">PLN</div>
                        </div>
                    </label>

                    <label class="block">
                        <span class="text-sm font-medium text-zinc-700">Horyzont czasowy (lata)</span>
                        <input id="rent-years-input" type="number" min="1" max="50" class="mt-1 block w-full rounded-lg border-zinc-300 focus:border-accent focus:ring-accent sm:text-sm h-11 px-3 border" placeholder="5">
                    </label>
                </div>

                <div class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <p id="rent-savings-result" class="text-sm text-blue-800 font-medium text-center">...</p>
                </div>

                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button id="close-rent-savings-modal" class="w-full py-2.5 rounded-lg border border-zinc-300 text-zinc-700 font-medium hover:bg-zinc-50 transition">Anuluj</button>
                    <button id="save-rent-savings" class="w-full py-2.5 rounded-lg bg-zinc-900 text-white font-medium hover:bg-black transition">Zapisz</button>
                </div>
                <button id="calculate-rent-savings" class="hidden"></button>
            </div>
        </div>
    </div>

    <button id="chat-fab" type="button" aria-label="Otwórz czat" class="chat-fab fixed bottom-24 md:bottom-6 left-6 z-[70] grid h-14 w-14 place-items-center rounded-full text-white shadow-xl hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="h-7 w-7 fill-current" aria-hidden="true"><path d="m55.438 5h-46.875c-3.625 0-6.563 2.918-6.563 6.517v29.793c0 3.598 2.938 6.518 6.563 6.518h6.918v11.172l10.39-11.172h29.567c3.626 0 6.563-2.92 6.563-6.518v-29.793c-.001-3.599-2.938-6.517-6.563-6.517m-39.451 25.604c-2.331 0-4.219-1.875-4.219-4.19 0-2.314 1.888-4.189 4.219-4.189s4.219 1.875 4.219 4.189c0 2.315-1.888 4.19-4.219 4.19m16.013 0c-2.329 0-4.219-1.875-4.219-4.19 0-2.314 1.89-4.189 4.219-4.189s4.219 1.875 4.219 4.189c0 2.315-1.89 4.19-4.219 4.19m16.013 0c-2.331 0-4.219-1.875-4.219-4.19 0-2.314 1.888-4.189 4.219-4.189 2.329 0 4.219 1.875 4.219 4.189-.001 2.315-1.89 4.19-4.219 4.19" /></svg>
    </button>

    <div id="chat-modal" class="fixed bottom-4 left-4 z-[80] hidden w-[calc(100vw-2rem)] max-w-sm md:w-96">
        <div class="relative w-full overflow-hidden rounded-2xl bg-white shadow-2xl border border-zinc-100 ring-1 ring-black/5">
            <div class="flex items-center justify-between border-b border-zinc-100 px-5 py-4 bg-zinc-50">
                <h3 class="text-base font-bold text-zinc-900">Porozmawiaj z nami</h3>
                <button id="chat-close-btn" class="rounded-full p-1 text-zinc-400 hover:bg-zinc-200 hover:text-zinc-700 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="max-h-[60vh] overflow-y-auto px-5 py-5 scrollbar-thin">
                <p class="mb-5 text-sm text-zinc-600">Obecnie brak dostępnych agentów. Zostaw dane, oddzwonimy.</p>
                <form id="chat-form" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="chat-first-name" placeholder="Imię" class="h-10 w-full rounded-lg bg-zinc-50 border border-zinc-200 px-3 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition">
                        <input id="chat-last-name" placeholder="Nazwisko" class="h-10 w-full rounded-lg bg-zinc-50 border border-zinc-200 px-3 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition">
                    </div>
                    <input id="chat-email" type="email" placeholder="E-mail" class="h-10 w-full rounded-lg bg-zinc-50 border border-zinc-200 px-3 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition">
                    <input id="chat-phone" type="tel" placeholder="Telefon" class="h-10 w-full rounded-lg bg-zinc-50 border border-zinc-200 px-3 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition">
                    <input id="chat-postal-code" placeholder="Kod pocztowy" class="h-10 w-full rounded-lg bg-zinc-50 border border-zinc-200 px-3 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition">
                    
                    <fieldset class="pt-2">
                        <legend class="text-xs font-semibold text-zinc-500 mb-2 uppercase tracking-wide">Interesuje mnie:</legend>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 text-xs text-zinc-700 p-2 rounded bg-zinc-50 hover:bg-zinc-100 cursor-pointer border border-transparent hover:border-zinc-200 transition">
                                <input type="checkbox" name="chat-product" value="Model 35" class="rounded border-zinc-300 text-accent focus:ring-accent"> Model 35
                            </label>
                            <label class="flex items-center gap-2 text-xs text-zinc-700 p-2 rounded bg-zinc-50 hover:bg-zinc-100 cursor-pointer border border-transparent hover:border-zinc-200 transition">
                                <input type="checkbox" name="chat-product" value="Model 50" class="rounded border-zinc-300 text-accent focus:ring-accent"> Model 50
                            </label>
                            <label class="flex items-center gap-2 text-xs text-zinc-700 p-2 rounded bg-zinc-50 hover:bg-zinc-100 cursor-pointer border border-transparent hover:border-zinc-200 transition">
                                <input type="checkbox" name="chat-product" value="Model 70" class="rounded border-zinc-300 text-accent focus:ring-accent"> Model 70
                            </label>
                            <label class="flex items-center gap-2 text-xs text-zinc-700 p-2 rounded bg-zinc-50 hover:bg-zinc-100 cursor-pointer border border-transparent hover:border-zinc-200 transition">
                                <input type="checkbox" name="chat-product" value="Garaż" class="rounded border-zinc-300 text-accent focus:ring-accent"> Garaż
                            </label>
                        </div>
                    </fieldset>
                    <button id="chat-submit-btn" type="submit" disabled class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-accent/20 transition hover:brightness-110 disabled:cursor-not-allowed disabled:bg-zinc-200 disabled:text-zinc-400 disabled:shadow-none">Wyślij zgłoszenie</button>
                </form>
            </div>
            <div id="chat-close-confirm" class="absolute inset-0 z-20 hidden flex-col items-center justify-center bg-white/95 backdrop-blur text-center p-6">
                <p class="mb-4 text-zinc-900 font-semibold">Zakończyć rozmowę?</p>
                <div class="flex gap-3">
                    <button id="chat-confirm-yes" class="px-4 py-2 bg-zinc-900 text-white rounded-lg text-sm font-medium hover:bg-black">Tak</button>
                    <button id="chat-confirm-no" class="px-4 py-2 border border-zinc-300 text-zinc-700 rounded-lg text-sm font-medium hover:bg-zinc-50">Nie</button>
                </div>
            </div>
        </div>
    </div>
    <div id="chat-success" class="pointer-events-none fixed left-1/2 top-20 z-[90] -translate-x-1/2 rounded-full bg-emerald-600 px-6 py-3 text-center text-sm font-bold text-white shadow-xl opacity-0 transition-all duration-500 scale-90">
        Dziękujemy! Skontaktujemy się wkrótce.
    </div>

    <script>
        const COLORS = [
            { id: 'white', name: 'Biel', hex: '#eceff3', price: 0 },
            { id: 'gray', name: 'Szary', hex: '#7a7a7a', price: 0 },
            { id: 'beige', name: 'Beż', hex: '#d6c7aa', price: 2800 },
            { id: 'brown', name: 'Brąz', hex: '#6b4d39', price: 3500 }
        ];

        const TERRACES = [
            { id: 'none', name: 'Bez tarasu', price: 0 },
            { id: 'terrace-open', name: 'Taras otwarty', price: 8500 },
            { id: 'terrace-covered', name: 'Taras zadaszony', price: 16500 }
        ];

        const GARAGES = [
            { id: 'none', name: 'Bez garażu', price: 0 },
            { id: 'garage-1', name: 'Garaż 1-stanowiskowy', price: 35000 },
            { id: 'garage-2', name: 'Garaż 2-stanowiskowy', price: 65000 },
            { id: 'garage-3', name: 'Garaż 3-stanowiskowy', price: 90000 }
        ];

        const MODELS = [
            {
                id: 'm35',
                query: '35',
                name: 'Dom 35 m²',
                subtitle: 'Model piętrowy',
                area: '70 m²', /* Dodano metraż */
                price: 206600,
                imagesByColor: {
                    gray: ['DOM35/L_GRAY/35_light_gray_front.webp', 'DOM35/L_GRAY/35_light_gray_right.webp'],
                    white: ['DOM35/WHITE/35_white_front.webp', 'DOM35/WHITE/35_white_right.webp'],
                    beige: ['DOM35/BEIGE/35_beige_front.webp', 'DOM35/BEIGE/35_beige_right.webp'],
                    brown: ['DOM35/DARK/35_dark_front.webp', 'DOM35/DARK/35_dark_right.webp']
                }
            },
            {
                id: 'm50',
                query: '50',
                name: 'Dom 50 m²',
                subtitle: 'Model z antresolą',
                area: '70 m²', /* Dodano metraż */
                price: 280000,
                imagesByColor: {
                    gray: ['DOM50/L_GRAY/50_light_gray_front.webp', 'DOM50/L_GRAY/50_light_gray_right.webp'],
                    white: ['DOM50/WHITE/50_white_front.webp', 'DOM50/WHITE/50_white_right.webp'],
                    beige: ['DOM50/BEIGE/50_beige_front.webp', 'DOM50/BEIGE/50_beige_right.webp'],
                    brown: ['DOM50/DARK/50_dark_front.webp', 'DOM50/DARK/50_dark_right.webp']
                }
            },
            {
                id: 'm70',
                query: '70',
                name: 'Dom 70 m²',
                subtitle: 'Model parterowy',
                area: '90 m²', /* TUTAJ ZMIANA NA 90 m² DLA MODELU 70 */
                price: 365300,
                imagesByColor: {
                    gray: ['DOM70/L_GRAY/70_light_gray_front.webp', 'DOM70/L_GRAY/70_light_gray_right.webp'],
                    white: ['DOM70/WHITE/70_white_front.webp', 'DOM70/WHITE/70_white_right.webp'],
                    beige: ['DOM70/BEIGE/70_beige_front.webp', 'DOM70/BEIGE/70_beige_right.webp'],
                    brown: ['DOM70/DARK/70_dark_front.webp', 'DOM70/DARK/70_dark_right.webp']
                }
            }
        ];

        // --- OPTYMALIZACJA: CACHE OBRAZÓW (Smart Preloading) ---
        const imageCache = new Set();
        
        function preloadAllImages() {
            const allUrls = [];
            MODELS.forEach(m => {
                Object.values(m.imagesByColor).forEach(urls => {
                    if (Array.isArray(urls)) allUrls.push(...urls);
                });
            });

            const processPreload = () => {
                if (allUrls.length === 0) return;
                const batch = allUrls.splice(0, 2);
                
                batch.forEach(url => {
                    if (!imageCache.has(url)) {
                        const img = new Image();
                        img.src = url;
                        img.onload = () => imageCache.add(url);
                        img.onerror = () => console.warn(`Nie można załadować zasobu w tle: ${url}`);
                    }
                });
                
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(processPreload);
                } else {
                    setTimeout(processPreload, 200);
                }
            };

            if ('requestIdleCallback' in window) {
                requestIdleCallback(processPreload);
            } else {
                setTimeout(processPreload, 500);
            }
        }
        // ------------------------------------------------

        const state = {
            modelId: 'm35',
            colorId: 'gray',
            terraceId: 'none',
            garageId: 'none',
            imageIndex: 0,
            includeSavings: true,
            rentMonthly: 2500,
            savingsYears: 4
        };

        const el = {
            rightPanel: document.getElementById('right-panel'),
            modelOptions: document.getElementById('model-options'),
            colorOptions: document.getElementById('color-options'),
            terraceOptions: document.getElementById('terrace-options'),
            garageOptions: document.getElementById('garage-options'),
            galleryTitle: document.getElementById('gallery-title'),
            gallerySubtitle: document.getElementById('gallery-subtitle'),
            galleryImage: document.getElementById('gallery-image'),
            galleryDots: document.getElementById('gallery-dots'),
            sumModel: document.getElementById('sum-model'),
            sumColor: document.getElementById('sum-color'),
            sumTerrace: document.getElementById('sum-terrace'),
            sumGarage: document.getElementById('sum-garage'),
            sumTotal: document.getElementById('sum-total'),
            sumToday: document.getElementById('sum-today'),
            barToday: document.getElementById('bar-today'),
            barEffective: document.getElementById('bar-effective'),
            savings5yInline: document.getElementById('savings-5y-inline'),
            openSavingsModal: document.getElementById('open-savings-modal'),
            savingsModal: document.getElementById('savings-modal'),
            savingsModalBackdrop: document.getElementById('savings-modal-backdrop'),
            closeSavingsModal: document.getElementById('close-savings-modal'),
            savingsToggle: document.getElementById('savings-toggle'),
            savingsYearly: document.getElementById('savings-yearly'),
            savingsYearsInline: document.getElementById('savings-years-inline'),
            savingsRentLabel: document.getElementById('savings-rent-label'),
            savingsRentYearly: document.getElementById('savings-rent-yearly'),
            modalBaseTotal: document.getElementById('modal-base-total'),
            modalEffectiveTotal: document.getElementById('modal-effective-total'),
            modalSavingsDeduction: document.getElementById('modal-savings-deduction'),
            modalYearsTotal: document.getElementById('modal-years-total'),
            modal5yTotal: document.getElementById('modal-5y-total'),
            openTermsModal: document.getElementById('open-terms-modal'),
            termsModal: document.getElementById('terms-modal'),
            termsModalBackdrop: document.getElementById('terms-modal-backdrop'),
            closeTermsModal: document.getElementById('close-terms-modal'),
            openRentSavingsModal: document.getElementById('open-rent-savings-modal'),
            rentSavingsModal: document.getElementById('rent-savings-modal'),
            rentSavingsModalBackdrop: document.getElementById('rent-savings-modal-backdrop'),
            closeRentSavingsModal: document.getElementById('close-rent-savings-modal'),
            rentMonthlyInput: document.getElementById('rent-monthly-input'),
            rentYearsInput: document.getElementById('rent-years-input'),
            calculateRentSavings: document.getElementById('calculate-rent-savings'),
            rentSavingsResult: document.getElementById('rent-savings-result'),
            saveRentSavings: document.getElementById('save-rent-savings'),
            summarySection: document.getElementById('summary-section'),
            paymentBar: document.getElementById('payment-bar'),
            chatFab: document.getElementById('chat-fab'),
            surfaceAreaValue: document.getElementById('surface-area-value') /* NOWE REFERENCJE */
        };

        const SAVINGS = {
            energyYearly: 7000,
            maintenanceYearly: 12000
        };

        const pln = (value) => `${new Intl.NumberFormat('pl-PL').format(value)} zł`;

        function selectedModel() { return MODELS.find((m) => m.id === state.modelId); }
        function selectedColor() { return COLORS.find((c) => c.id === state.colorId); }
        function selectedTerrace() { return TERRACES.find((t) => t.id === state.terraceId); }
        function selectedGarage() { return GARAGES.find((g) => g.id === state.garageId); }

        function modelImages() {
            const map = selectedModel().imagesByColor;
            const current = map[state.colorId];
            return Array.isArray(current) ? current : [current];
        }

        function totalPrice() {
            return selectedModel().price + selectedColor().price + selectedTerrace().price + selectedGarage().price;
        }

        function yearlySavings() {
            return SAVINGS.energyYearly + SAVINGS.maintenanceYearly + (state.rentMonthly * 12);
        }

        function savingsForConfiguredYears() {
            return yearlySavings() * state.savingsYears;
        }

        function parseNonNegative(value, fallback) {
            const parsed = Number(value);
            return (!Number.isFinite(parsed) || parsed < 0) ? fallback : Math.round(parsed);
        }

        function parsePositive(value, fallback) {
            const parsed = Number(value);
            return (!Number.isFinite(parsed) || parsed <= 0) ? fallback : Math.round(parsed);
        }

        function updateBodyScrollLock() {
            const anyModalOpen =
                !el.savingsModal.classList.contains('hidden') ||
                !el.rentSavingsModal.classList.contains('hidden') ||
                !el.termsModal.classList.contains('hidden');
            document.body.classList.toggle('overflow-hidden', anyModalOpen);

            if (el.chatFab) {
                const termsModalOpen = !el.termsModal.classList.contains('hidden');
                el.chatFab.classList.toggle('chat-fab-disabled', termsModalOpen);
                el.chatFab.disabled = termsModalOpen;
            }
        }

        function toggleModal(modal, show) {
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
            updateBodyScrollLock();
        }

        function renderRentSavingsPreview() {
            const monthly = parseNonNegative(el.rentMonthlyInput.value, state.rentMonthly);
            const years = parsePositive(el.rentYearsInput.value, state.savingsYears);
            const total = monthly * 12 * years;
            el.rentSavingsResult.textContent = `Przez ${years} lat zaoszczędzisz ${pln(total)} na czynszu/najmie`;
        }

        function syncUrlWithModel() {
            const current = selectedModel();
            const url = new URL(window.location.href);
            url.searchParams.set('model', current.query);
            window.history.replaceState({}, '', url.toString());
        }

        function applyModelFromQuery() {
            const param = new URLSearchParams(window.location.search).get('model');
            if (!param) return;
            const normalized = param.toLowerCase();
            const target = MODELS.find((m) => m.query === normalized || m.id === normalized);
            if (target) state.modelId = target.id;
        }

        function renderModelOptions() {
            el.modelOptions.innerHTML = MODELS.map((m) => {
                const active = m.id === state.modelId;
                return `
                <button data-model-id="${m.id}" class="model-btn w-full text-left rounded-xl border p-4 transition duration-200 ${active ? 'border-zinc-900 bg-zinc-900 text-white shadow-md' : 'border-zinc-200 bg-white hover:border-zinc-300 hover:shadow-sm'}">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="font-bold text-lg leading-tight">${m.name}</p>
                      <p class="text-sm ${active ? 'text-zinc-300' : 'text-zinc-500'} mt-1">${m.subtitle}</p>
                    </div>
                    <p class="font-bold whitespace-nowrap">${pln(m.price)}</p>
                  </div>
                </button>`;
            }).join('');
        }

        function renderColors() {
            const activeColor = selectedColor();
            el.colorOptions.innerHTML = `
            <div class="color-picker">
              <div class="color-meta" aria-live="polite">
                <p class="color-meta-price">${activeColor.price ? '+ ' + pln(activeColor.price) : 'W zestawie'}</p>
                <p class="color-meta-name">${activeColor.name}</p>
              </div>
              <div class="color-swatches" role="radiogroup">
                ${COLORS.map((c) => {
                    const active = c.id === state.colorId;
                    return `<button type="button" data-color-id="${c.id}" class="color-btn" data-selected="${active}" style="--swatch-color:${c.hex}" aria-label="${c.name}"></button>`;
                }).join('')}
              </div>
            </div>`;
        }

        function renderExclusiveOptions(list, selectedId, cssClass, targetEl) {
            targetEl.innerHTML = list.map((item) => {
                const active = item.id === selectedId;
                return `
                <button data-option-id="${item.id}" class="${cssClass} w-full text-left rounded-xl border p-3.5 transition duration-200 ${active ? 'border-zinc-900 bg-zinc-900 text-white shadow-md' : 'border-zinc-200 bg-white hover:border-zinc-300 hover:shadow-sm'}">
                  <div class="flex items-center justify-between gap-3">
                    <span class="font-semibold">${item.name}</span>
                    <span class="text-sm font-medium whitespace-nowrap">${item.price ? '+ ' + pln(item.price) : 'W cenie'}</span>
                  </div>
                </button>`;
            }).join('');
        }

        // --- CORE: LOGIKA WYŚWIETLANIA ZDJĘĆ ---
        function renderGallery() {
            const model = selectedModel();
            const images = modelImages();
            const idx = ((state.imageIndex % images.length) + images.length) % images.length;
            const currentImage = images[idx];

            el.galleryTitle.textContent = model.name;
            el.gallerySubtitle.textContent = 'Szacowany termin startu budowy: marzec 2026';

            el.galleryDots.innerHTML = images.map((_, i) => 
                `<span class="transition-all duration-300 ${i === idx ? 'w-6 bg-white shadow' : 'w-2 bg-white/50 hover:bg-white/80'} h-2 rounded-full cursor-pointer"></span>`
            ).join('');

            const imgEl = el.galleryImage;
            
            if (imgEl.src.endsWith(currentImage)) {
                if (!imgEl.classList.contains('loaded')) imgEl.classList.add('loaded');
                return;
            }

            imgEl.classList.remove('loaded');

            const tempImg = new Image();
            tempImg.src = currentImage;

            const updateImage = () => {
                imgEl.src = currentImage;
                void imgEl.offsetWidth; 
                imgEl.classList.add('loaded');
            };

            if ('decode' in tempImg) {
                tempImg.decode()
                    .then(() => {
                        updateImage();
                    })
                    .catch((err) => {
                        console.error('Błąd dekodowania obrazu:', err);
                        imgEl.src = currentImage; 
                        imgEl.onerror = () => {
                             console.warn('Obraz nie istnieje, ładuję placeholder.');
                             imgEl.src = 'https://placehold.co/1200x900/e4e4e7/52525b?text=Wizualizacja+' + model.query;
                             imgEl.classList.add('loaded');
                        }
                        updateImage();
                    });
            } else {
                tempImg.onload = updateImage;
            }
        }

        function renderSummary() {
            const model = selectedModel();
            const color = selectedColor();
            const terrace = selectedTerrace();
            const garage = selectedGarage();
            const total = totalPrice();
            const today = Math.round(total * 0.4);

            el.sumModel.textContent = `${model.name} (${pln(model.price)})`;
            el.sumColor.textContent = `${color.name}${color.price ? ` (+ ${pln(color.price)})` : ''}`;
            el.sumTerrace.textContent = `${terrace.name}${terrace.price ? ` (+ ${pln(terrace.price)})` : ''}`;
            el.sumGarage.textContent = `${garage.name}${garage.price ? ` (+ ${pln(garage.price)})` : ''}`;
            el.sumTotal.textContent = pln(total);
            el.sumToday.textContent = pln(today);
            el.barToday.textContent = pln(today);

            /* AKTUALIZACJA POWIERZCHNI UŻYTKOWEJ */
            if (el.surfaceAreaValue) {
                el.surfaceAreaValue.textContent = model.area;
            }
        }

        function renderSavingsModal() {
            const total = totalPrice();
            const yearly = yearlySavings();
            const configuredYears = savingsForConfiguredYears();
            const effective = Math.max(total - yearly, 0);
            const rentYearly = state.rentMonthly * 12;

            el.savings5yInline.textContent = pln(configuredYears);
            el.savingsYearsInline.textContent = `${state.savingsYears} lat`;
            el.savingsYearly.textContent = `${pln(yearly)}/rok`;
            el.savingsRentLabel.textContent = `Najem (${new Intl.NumberFormat('pl-PL').format(state.rentMonthly)} zł/mc)`;
            el.savingsRentYearly.textContent = `${pln(rentYearly)}/rok`;
            el.modalBaseTotal.textContent = pln(total);
            el.modalYearsTotal.textContent = `${state.savingsYears} lat`;
            el.modal5yTotal.textContent = pln(configuredYears);
            el.savingsToggle.checked = state.includeSavings;
            el.modalSavingsDeduction.textContent = state.includeSavings ? `- ${pln(yearly)}` : '- 0 zł';
            el.modalEffectiveTotal.textContent = state.includeSavings ? pln(effective) : pln(total);
        }

        // --- SCROLL & LAYOUT LOGIC ---
        function setupPaymentBarVisibility() {
            const summary = document.getElementById('summary-section');
            const bar = document.getElementById('payment-bar');
            if (!summary || !bar) return;

            const update = () => {
                const rect = summary.getBoundingClientRect();
                const windowHeight = window.innerHeight;
                const isVisible = (rect.top < windowHeight) && (rect.bottom > 0);
                
                if (isVisible) {
                    bar.style.opacity = '0';
                    bar.style.pointerEvents = 'none';
                    bar.style.transform = 'translateY(100%)';
                } else {
                    bar.style.opacity = '1';
                    bar.style.pointerEvents = 'auto';
                    bar.style.transform = 'translateY(0)';
                }
            };
            window.addEventListener('scroll', update, { passive: true });
            window.addEventListener('resize', update);
            update();
        }

        function syncPaymentBarBounds() {
            if (!el.rightPanel || !el.paymentBar) return;
        }

        function syncGalleryWithColor() {
            const images = modelImages();
            if (!images.length) { state.imageIndex = 0; return; }
            state.imageIndex = ((state.imageIndex % images.length) + images.length) % images.length;
        }

        function rerenderAll() {
            renderModelOptions();
            renderColors();
            renderExclusiveOptions(TERRACES, state.terraceId, 'terrace-btn', el.terraceOptions);
            renderExclusiveOptions(GARAGES, state.garageId, 'garage-btn', el.garageOptions);
            renderGallery();
            renderSummary();
            renderSavingsModal();
            syncUrlWithModel();
        }

        // --- EVENTS ---
        document.getElementById('gallery-prev').addEventListener('click', () => { state.imageIndex--; syncGalleryWithColor(); renderGallery(); });
        document.getElementById('gallery-next').addEventListener('click', () => { state.imageIndex++; syncGalleryWithColor(); renderGallery(); });

        el.modelOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('.model-btn');
            if (!btn) return;
            state.modelId = btn.dataset.modelId;
            state.colorId = 'gray'; // Reset koloru
            state.imageIndex = 0;
            rerenderAll();
        });

        el.colorOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('.color-btn');
            if (!btn) return;
            state.colorId = btn.dataset.colorId;
            state.imageIndex = 0;
            renderColors();
            renderGallery();
            renderSummary();
        });

        el.terraceOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('.terrace-btn');
            if (!btn) return;
            state.terraceId = btn.dataset.optionId;
            renderExclusiveOptions(TERRACES, state.terraceId, 'terrace-btn', el.terraceOptions);
            renderSummary();
        });

        el.garageOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('.garage-btn');
            if (!btn) return;
            state.garageId = btn.dataset.optionId;
            renderExclusiveOptions(GARAGES, state.garageId, 'garage-btn', el.garageOptions);
            renderSummary();
        });

        // Modals listeners
        el.openSavingsModal.addEventListener('click', () => toggleModal(el.savingsModal, true));
        el.closeSavingsModal.addEventListener('click', () => toggleModal(el.savingsModal, false));
        el.savingsModalBackdrop.addEventListener('click', () => toggleModal(el.savingsModal, false));
        
        el.openTermsModal.addEventListener('click', () => toggleModal(el.termsModal, true));
        el.closeTermsModal.addEventListener('click', () => toggleModal(el.termsModal, false));
        el.termsModalBackdrop.addEventListener('click', () => toggleModal(el.termsModal, false));

        el.openRentSavingsModal.addEventListener('click', () => {
            el.rentMonthlyInput.value = state.rentMonthly;
            el.rentYearsInput.value = state.savingsYears;
            renderRentSavingsPreview();
            toggleModal(el.rentSavingsModal, true);
        });
        el.closeRentSavingsModal.addEventListener('click', () => toggleModal(el.rentSavingsModal, false));
        
        el.rentMonthlyInput.addEventListener('input', renderRentSavingsPreview);
        el.rentYearsInput.addEventListener('input', renderRentSavingsPreview);
        
        el.saveRentSavings.addEventListener('click', () => {
            state.rentMonthly = parseNonNegative(el.rentMonthlyInput.value, state.rentMonthly);
            state.savingsYears = parsePositive(el.rentYearsInput.value, state.savingsYears);
            renderSavingsModal();
            renderSummary();
            toggleModal(el.rentSavingsModal, false);
            toggleModal(el.savingsModal, false);
        });

        el.savingsToggle.addEventListener('change', () => {
            state.includeSavings = el.savingsToggle.checked;
            renderSavingsModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleModal(el.rentSavingsModal, false);
                toggleModal(el.termsModal, false);
                toggleModal(el.savingsModal, false);
            }
        });

        // Init
        applyModelFromQuery();
        rerenderAll();
        setupPaymentBarVisibility();
        preloadAllImages(); // Start smart preload

    </script>

    <script>
        (function initChat() {
            const dom = {
                fab: document.getElementById('chat-fab'),
                modal: document.getElementById('chat-modal'),
                closeBtn: document.getElementById('chat-close-btn'),
                confirm: document.getElementById('chat-close-confirm'),
                yes: document.getElementById('chat-confirm-yes'),
                no: document.getElementById('chat-confirm-no'),
                form: document.getElementById('chat-form'),
                success: document.getElementById('chat-success'),
                submit: document.getElementById('chat-submit-btn'),
                inputs: document.querySelectorAll('#chat-form input:not([type="checkbox"])'),
                checks: document.querySelectorAll('input[name="chat-product"]')
            };

            if (!dom.fab) return;

            function checkValidity() {
                const filled = Array.from(dom.inputs).every(i => i.value.trim().length > 0);
                const checked = Array.from(dom.checks).some(c => c.checked);
                dom.submit.disabled = !(filled && checked);
            }

            dom.fab.addEventListener('click', () => { dom.modal.classList.remove('hidden'); dom.confirm.classList.add('hidden'); dom.confirm.classList.remove('flex'); });
            dom.closeBtn.addEventListener('click', () => { dom.confirm.classList.remove('hidden'); dom.confirm.classList.add('flex'); });
            dom.yes.addEventListener('click', () => dom.modal.classList.add('hidden'));
            dom.no.addEventListener('click', () => { dom.confirm.classList.add('hidden'); dom.confirm.classList.remove('flex'); });

            dom.inputs.forEach(i => i.addEventListener('input', checkValidity));
            dom.checks.forEach(c => c.addEventListener('change', checkValidity));

            dom.form.addEventListener('submit', (e) => {
                e.preventDefault();
                dom.modal.classList.add('hidden');
                dom.success.classList.remove('opacity-0', 'scale-90');
                dom.success.classList.add('scale-100');
                setTimeout(() => {
                    dom.success.classList.add('opacity-0', 'scale-90');
                    dom.success.classList.remove('scale-100');
                }, 4000);
                dom.form.reset();
                checkValidity();
            });
            
            // Sync FAB color
            const observer = new MutationObserver(() => {
                const active = document.querySelector('.model-btn.border-zinc-900');
                if(active) {
                    const style = getComputedStyle(active);
                    dom.fab.style.setProperty('--chat-fab-base-color', style.backgroundColor);
                    dom.fab.style.setProperty('--chat-fab-ink-color', style.color);
                }
            });
            observer.observe(document.getElementById('model-options'), { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });

        })();
    </script>
</body>
</html>