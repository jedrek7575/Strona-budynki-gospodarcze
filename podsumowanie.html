<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Podsumowanie zamówienia | Zabudo.pl</title>
  <meta name="description" content="Podsumowanie konfiguracji budynku oraz płatność zaliczki online – Zabudo.pl" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root { --brand:#1e2022; --accent:#0d6efd; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; color:#1a1a1a; }
    .navbar { box-shadow: 0 8px 24px rgba(0,0,0,.05); background:#fff; }
    .logo { height: 36px; }
    .hero { padding: 80px 0 24px; background:linear-gradient(180deg, rgba(13,110,253,.06), transparent); }
    .hero h1 { font-weight:700; font-size: clamp(1.4rem, 2.5vw, 2rem); }
    .card { border: 1px solid rgba(0,0,0,.08); box-shadow: 0 10px 30px rgba(0,0,0,.05); border-radius: 16px; }
    .summary-row { display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px dashed rgba(0,0,0,.08); }
    .summary-row:last-child { border-bottom:none; }
    .price { font-size:1.25rem; font-weight:700; }
    .muted { color:#6c757d; }
    .badge-pill { border-radius: 999px; font-weight:600; }
    .footer-note { font-size:.9rem; color:#6c757d; }
    .pay-btn[disabled] { pointer-events:none; opacity:.8; }
    .divider { height:1px; background:rgba(0,0,0,.08); margin:16px 0; }
    html, body { height: 100%; }
    body { display:flex; flex-direction:column; }
  </style>

  <!-- Twój globalny CSS, jeśli masz -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Top bar -->
  <nav class="navbar white navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img class="logo" src="logo_zabudo_black.webp" alt="Zabudo.pl" loading="lazy" />
      </a>
      <div class="ms-auto d-none d-lg-flex align-items-center gap-3">
        <a class="text-decoration-none text-dark" href="tel:+48503702467"><i class="fa-solid fa-phone"></i> +48 503 702 467</a>
        <a class="btn btn-sm btn-outline-dark" href="/#contact">Kontakt</a>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <h1 class="m-0">Podsumowanie zamówienia</h1>
            <a href="/garaż.html" class="btn btn-link">← Wróć do konfiguratora</a>
          </div>
          <p class="muted mb-0">Sprawdź szczegóły swojej konfiguracji i opłać zaliczkę, aby zarezerwować termin montażu.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Summary + Płatność -->
  <main class="flex-grow-1 d-flex align-items-center py-3 py-md-4 checkout-main">
    <div class="container">
      <div class="row justify-content-center g-4">
        <div class="col-lg-8">
          <div class="card p-3 p-md-4">
            
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <span class="badge text-bg-light border badge-pill"><i class="fa-regular fa-building"></i> <span id="sum-type">—</span></span>
                <span class="badge text-bg-light border badge-pill"><i class="fa-solid fa-ruler-combined"></i> <span id="sum-dim">—</span></span>
                <span class="badge text-bg-light border badge-pill"><i class="fa-solid fa-up-down"></i> <span id="sum-heights">—</span></span>
              </div>

            </div>

            <div class="divider"></div>

            <div class="summary-row"><span>Cena brutto</span><span class="price" id="sum-price">—</span></div>
            <div class="summary-row"><span>Zaliczka <span class="muted">(20%)</span></span><span class="price text-primary" id="sum-deposit">—</span></div>

            <div class="mt-3 footer-note">
              Po zaksięgowaniu płatności skontaktujemy się z Państwem w ciągu 48 godzin w celu ustalenia terminu montażu.
              Kwota zaliczki zostanie odliczona od ceny końcowej przy rozliczeniu. Płatność realizowana za pomocą Przelewy24.
            </div>

            <div class="divider"></div>

            <h6 class="fw-semibold">Wybrane opcje</h6>
            <div id="sum-options" class="small"></div>


<!-- Dane do zamówienia -->
<div class="divider"></div>
<h6 class="fw-semibold mb-2">Dane do zamówienia</h6>

<form id="orderForm" novalidate>
  <div class="row g-3">
    <div class="col-md-6">
      <label for="custName" class="form-label">Imię i nazwisko <span class="text-danger">*</span></label>
      <input type="text" id="custName" class="form-control" placeholder="" required>
      <div class="invalid-feedback">Podaj imię i nazwisko.</div>
    </div>

    <div class="col-md-6">
      <label for="custPhone" class="form-label">Numer telefonu <span class="text-danger">*</span></label>
      <input type="tel" id="custPhone" class="form-control" placeholder=""
             pattern="^[0-9+\s-]{9,}$" required>
      <div class="invalid-feedback">Podaj prawidłowy numer telefonu.</div>
    </div>

    <div class="col-md-6">
      <label for="custEmail" class="form-label">Adres e-mail <span class="text-danger">*</span></label>
      <input type="email" id="custEmail" class="form-control" placeholder="" required>
      <div class="invalid-feedback">Podaj prawidłowy adres e-mail.</div>
    </div>

    <div class="col-md-6">
      <label for="addrStreet" class="form-label">Ulica i numer <span class="text-danger">*</span></label>
      <input type="text" id="addrStreet" class="form-control" placeholder="" required>
      <div class="invalid-feedback">Podaj ulicę i numer.</div>
    </div>

    <div class="col-md-4">
      <label for="addrPostal" class="form-label">Kod pocztowy <span class="text-danger">*</span></label>
      <input type="text" id="addrPostal" class="form-control" placeholder=""
             pattern="^[0-9]{2}-?[0-9]{3}$" required>
      <div class="invalid-feedback">Podaj kod w formacie 00-000.</div>
    </div>

    <div class="col-md-8">
      <label for="addrCity" class="form-label">Miejscowość <span class="text-danger">*</span></label>
      <input type="text" id="addrCity" class="form-control" placeholder="" required>
      <div class="invalid-feedback">Podaj miejscowość.</div>
    </div>
  </div>
</form>




            <div class="mt-4 d-flex flex-wrap gap-2 justify-content-end">
              <a class="btn btn-outline-secondary" href="/garaż.html">Zmień konfigurację</a>
              <button id="payDepositBtn" class="btn btn-primary pay-btn">
                <i class="fa-solid fa-shield"></i> Złóż zamówienie
              </button>
            </div>
          </div>

          <div class=" mt-3">
            <small class="text-muted d-block mt-2">
  Klikając przycisk <strong>„Złóż zamówienie”</strong>:
  <ul class="small mb-0">
    <li>zawierasz umowę sprzedaży/świadczenia usług z <strong>Zabudo.pl sp. z o.o.</strong>,</li>
    <li>potwierdzasz, że zapoznałeś(-aś) się i akceptujesz <a href="regulamin-sprzedazy.html" target="_blank">Regulamin sprzedaży</a>, 
        <a href="polityka-prywatnosci.html" target="_blank">Politykę prywatności</a> oraz zasady korzystania z plików cookies,</li>
    <li>wyrażasz zgodę na przetwarzanie podanych danych osobowych w celu realizacji zamówienia zgodnie z RODO.</li>
  </ul>
</small>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-3 p-md-4">
            <h6 class="fw-semibold mb-2">Dane kontaktowe</h6>
            <ul class="list-unstyled small m-0">
              <li>ZABUDO.PL spółka z o.o.</li>
              <li>NIP 6252502129</li>
              <li>KRS 0001194079</li>
              <li><i class="fa-solid fa-phone me-2"></i><a class="text-decoration-none text-dark" href="tel:+48503702467">+48 503 702 467</a></li>
              <li class="mt-1"><i class="fa-regular fa-envelope me-2"></i><a class="text-decoration-none text-dark" href="mailto:adam@zabudo.pl">adam@zabudo.pl</a></li>
            </ul>
            <div class="divider"></div>
            <div class="small text-muted">Masz pytania do zamówienia lub chcesz zmienić szczegóły? Zadzwoń – doradzimy.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>&copy; <span id="year"></span> Zabudo.pl</p>
              <p>NIP: 6252502129</p>
      <div class="footer-description">
        <p>Telefon: <a href="tel:+48503702467">+48 503 702 467</a> | <a href="tel:+48500156450">+48 500 156 450</a></p>
        <p>Email: <a href="mailto:adam@zabudo.pl">adam@zabudo.pl</a></p>
        <a href="polityka-prywatności.html">Polityka prywatności</a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Helpers =====
    const fmtPLN = (grosze) => new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format((grosze||0)/100);
    function parsePLNToGrosze(txt){
      if(!txt) return 0;
      const n=(txt+"").replace(/[^0-9,\.]/g,'').replace(',', '.');
      return Math.round((parseFloat(n)||0)*100);
    }
    function qs(name){ return new URLSearchParams(location.search).get(name); }

    // ===== Źródło danych: sessionStorage.orderConfig (pełna konfiguracja) =====
    function loadOrderConfig(){
      try {
        const raw = sessionStorage.getItem('orderConfig');
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e){ return null; }
    }

    // Fallback: minimalne dane z query/localStorage (gdyby ktoś odświeżył stronę po czasie)
    function loadFallback(){
      const type   = qs('type') || localStorage.getItem('zabudo_type') || 'Garaż';
      const width  = qs('width') || localStorage.getItem('zabudo_width') || '—';
      const length = qs('length')|| localStorage.getItem('zabudo_length')|| '—';
      const priceParam = qs('price');
      let priceGross = 0;
      if (priceParam && /^\d+$/.test(priceParam)) priceGross = parseInt(priceParam,10);
      else if (priceParam) priceGross = parsePLNToGrosze(priceParam);
      else priceGross = parseInt(localStorage.getItem('zabudo_price_grosze')||'0',10);

      return {
        version: 1,
        ts: new Date().toISOString(),
        build: {
          buildType: type,
          width: parseFloat(width)||width,
          length: parseFloat(length)||length,
          height_eave: null,
          height_peak: null,
          shownPrice: priceGross ? fmtPLN(priceGross) : ''
        },
        services: []
      };
    }

    function computeDepositGrosze(total){
      const pct = Math.round((total * 20) / 100);
      const min = 300 * 100;
      return Math.max(pct, min);
    }

// PLN bez groszy, jak w konfiguratorze: "12 345 zł"
const fmtZl = (pln) => `${(pln||0).toLocaleString('pl-PL')} zł`;

// wartość opcji w PLN (typ "sqm" mnożymy przez m², "fixed" to kwota stała)
function optionValuePLN(sel, area){
  const unit = Number(sel?.price) || 0;
  const type = String(sel?.type || 'fixed').toLowerCase();
  return Math.round(type === 'sqm' ? unit * (area || 0) : unit);
}


function renderOptions(services, area){
  if (!services || !services.length) {
    return '<p class="text-muted m-0">Brak dodatkowych opcji.</p>';
  }
  return `
    <ul class="m-0">
      ${services.map(s => {
        const g = s.group || 'Opcja';
        const sel = s.selected || s; // obsługa obu formatów
        const label = (sel?.label || '—').replace(/\s+/g,' ').trim();
        const val = optionValuePLN(sel, area); // PLN
        return `<li><strong>${g}</strong>: ${label} <span class="text-muted">(+${fmtZl(val)})</span></li>`;
      }).join('')}
    </ul>`;
}

function renderSummary(){
  const saved = loadOrderConfig() || loadFallback();
  const b = saved.build || {};
  const services = saved.services || [];

  const type   = b.buildType || b.type || 'Garaż';
  const width  = Number(b.width);
  const length = Number(b.length);
  const hEave  = b.height_eave;
  const hPeak  = b.height_peak;

  let priceGross = 0;
  if (typeof b.priceGrosze === 'number') priceGross = b.priceGrosze;
  else if (b.shownPrice) priceGross = parsePLNToGrosze(b.shownPrice);

  document.getElementById('sum-type').textContent = type;
  document.getElementById('sum-dim').textContent = `${b.width} × ${b.length} m`;
  document.getElementById('sum-heights').textContent =
    (hEave || hPeak) ? `okap ${hEave ?? '—'} m / kalenica ${hPeak ?? '—'} m` : 'wysokość: —';

  document.getElementById('sum-price').textContent = priceGross ? fmtPLN(priceGross) : '—';
  const deposit = computeDepositGrosze(priceGross||0);
  document.getElementById('sum-deposit').textContent = fmtPLN(deposit);

  // powierzchnia m² do przeliczeń "sqm"
  const area = (Number.isFinite(width) && Number.isFinite(length)) ? width * length : 0;

  // TU przekazujemy area → pokaże "(+ X zł)" przy każdej opcji
  document.getElementById('sum-options').innerHTML = renderOptions(services, area);

  window.__zabudo_summary = {
    type, width: b.width, length: b.length,
    height_eave: hEave, height_peak: hPeak,
    priceGross, deposit, services
  };
}



function getOrderCustomerData() {
  const name  = document.getElementById('custName').value.trim();
  const phone = document.getElementById('custPhone').value.trim();
  const email = document.getElementById('custEmail').value.trim();
  const street = document.getElementById('addrStreet').value.trim();
  const postal = document.getElementById('addrPostal').value.trim();
  const city   = document.getElementById('addrCity').value.trim();

  return {
    name, phone, email,
    address_street: street,
    address_postal: postal,
    address_city: city,
    address_full: [street, postal, city].filter(Boolean).join(', ')
  };
}

function validateOrderForm() {
  const form = document.getElementById('orderForm');
  let ok = true;

  // czyść poprzednie stany
  form.querySelectorAll('input').forEach(el => el.classList.remove('is-invalid'));

  // HTML5 validity + własne patterny
  form.querySelectorAll('input[required]').forEach(el => {
    if (!el.checkValidity()) {
      el.classList.add('is-invalid');
      ok = false;
    }
  });

  // extra: minimalna długość imienia i nazwiska
  const name = document.getElementById('custName');
  if (name.value.trim().length < 3) { name.classList.add('is-invalid'); ok = false; }

  if (!ok) {
    // scroll do pierwszego błędu
    const first = form.querySelector('.is-invalid');
    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  return ok;
}



    async function startPayment(){
  // walidacja wymaganych danych
  if (!validateOrderForm()) return;

  const S = window.__zabudo_summary || {};
  const btn = document.getElementById('payDepositBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Przekierowuję…';

  // dane klienta
  const C = getOrderCustomerData();
  // pamiętaj e-mail na później (np. dla autouzupełniania)
  sessionStorage.setItem('customerEmail', C.email || '');
  sessionStorage.setItem('customerPhone', C.phone || '');
  sessionStorage.setItem('customerName', C.name || '');
  sessionStorage.setItem('customerAddress', C.address_full || '');

  // metadata: cała konfiguracja + dane klienta/adres
  const metadata = {
    type: String(S.type||''),
    width: String(S.width||''),
    length: String(S.length||''),
    height_eave: String(S.height_eave ?? ''),
    height_peak: String(S.height_peak ?? ''),
    estimate_grosze: String(S.priceGross||0),
    services_json: JSON.stringify(S.services||[]),

    customer_name: C.name,
    customer_phone: C.phone,
    customer_email: C.email,
    delivery_address: C.address_full,
    delivery_street: C.address_street,
    delivery_postal: C.address_postal,
    delivery_city: C.address_city
  };

  try{
    // TODO: jeśli używasz Cloudflare Worker + P24, zmień endpoint na /api/p24/register:
    // const res = await fetch('https://TWÓJ-WORKER.workers.dev/api/p24/register', { ... })

    const res = await fetch('/api/create-checkout-session', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        amount: S.deposit || 0, // grosze
        currency: 'pln',
        description: `Zaliczka – ${S.type} ${S.width}×${S.length} m`,
        metadata
      })
    });

    const data = await res.json();
    if (data && data.url) {
      location.href = data.url;
    } else {
      throw new Error('Brak URL kasy.');
    }
  } catch (err) {
    console.error(err);
    alert('Nie udało się zainicjować płatności. Spróbuj ponownie.');
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-shield"></i> Złóż zamówienie';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('year').textContent = new Date().getFullYear();
  renderSummary();

  // autouzupełnij, jeśli były wcześniej wpisane
  const email = sessionStorage.getItem('customerEmail') || '';
  const phone = sessionStorage.getItem('customerPhone') || '';
  const name  = sessionStorage.getItem('customerName') || '';
  const addr  = (sessionStorage.getItem('customerAddress') || '').split(',').map(s=>s.trim());

  if (document.getElementById('custEmail')) document.getElementById('custEmail').value = email;
  if (document.getElementById('custPhone')) document.getElementById('custPhone').value = phone;
  if (document.getElementById('custName'))  document.getElementById('custName').value  = name;

  // jeśli chcesz rozbić adres automatycznie – zostaw ręcznie wpisywane; tu tylko przykład
  document.getElementById('payDepositBtn').addEventListener('click', startPayment);
});

  </script>
</body>
</html>
